-- Procedure para alternar a relação dos favoritos
DELIMITER $$
CREATE PROCEDURE altenar_relacao_favoritos(
		IN input_log_id INT,
        IN input_usuario_id INT
)
BEGIN
	DECLARE log_existe INT;
    DECLARE usuario_existe INT;
    DECLARE favorito_existe INT;
    
    SELECT COUNT(id) FROM tbl_usuario WHERE id = input_usuario_id INTO usuario_existe;
    SELECT COUNT(id) FROM tbl_log WHERE id = input_log_id INTO log_existe;
    SELECT COUNT(id) FROM tbl_favorito WHERE usuario_id = input_usuario_id AND log_id = input_log_id INTO favorito_existe;
    
    IF usuario_existe = 0 OR log_existe = 0
    THEN
		SELECT "ERROR_404: Usuário ou Log não foi encontrado na base de dados" MESSAGE;
	ELSEIF favorito_existe = 1
    THEN
		DELETE FROM tbl_favorito WHERE usuario_id = input_usuario_id AND log_id = input_log_id;
    ELSEIF favorito_existe = 0
    THEN
		INSERT INTO tbl_favorito(usuario_id, log_id)
        VALUES(input_usuario_id, input_log_id);
    END IF;
END $$
DELIMITER ;

-- Triggers para contagem dos Favoritos após um insert e delete
DELIMITER $$
CREATE TRIGGER trg_atualizar_favoritos_insert
AFTER INSERT ON tbl_favorito FOR EACH ROW
BEGIN
	DECLARE numero_favoritos INT;
    
    SELECT COUNT(id) INTO numero_favoritos FROM tbl_favorito WHERE log_id = NEW.log_id; 
	
	UPDATE tbl_log SET contagem_favoritos = numero_favoritos
	WHERE id = NEW.log_id;
END$$	
DELIMITER ;

DELIMITER $$
CREATE TRIGGER trg_atualizar_favoritos_delete
AFTER DELETE ON tbl_favorito FOR EACH ROW
BEGIN
	DECLARE numero_favoritos INT;
    
    SELECT COUNT(id) INTO numero_favoritos FROM tbl_favorito WHERE log_id = OLD.log_id; 

    UPDATE tbl_log SET contagem_favoritos = numero_favoritos
	WHERE id = OLD.log_id;
END$$	
DELIMITER ;